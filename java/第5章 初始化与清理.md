# 第5章 初始化与清理

#### 5.1 用构造器确保初始化

在java中，通过提供构造器，类的设计者可确保每个对象都会得到初始化。

在创建对象时，会为对象分配存储空间，并调用相应构造器，从而确保在操作对象之前，它已经被恰当的初始化了。

构造器是一种特殊类型的方法，因为它没有返回值。

#### 5.2 方法重载

为了让方法名相同而形式参数不同的构造器同时存在，必须用到方法重载。

区分重载方法：每个重载的方法都必须有一个独一无二的参数类型列表，参数顺序不同也可以区分两个方法，但会使代码难以维护。

#### 5.3 默认构造器

如果你写的类中没有构造器，编译器会自动创建一个默认构造器；但如果已经定义了构造器（无论是否有参数），编译器不会自动创建默认构造器。

#### 5.4 this关键词

this关键字只能在方法内部使用，表示对”调用方法的那个对象“的引用

#### 5.5 清理：终结处理和垃圾回收

由于垃圾回收器只知道释放那些经由 **new**分配的内存。为了应对这种情况，java允许在类中定义一个名为**finalize()**的方法。一旦垃圾回收器准备好释放对象占用的存储空间，将首先调用其**finalize()**方法，并且在下一次垃圾回收动作发生时，才会真正回收对象占用的内存。

关于垃圾回收：

1. 对象可能不被垃圾回收

2. 垃圾回收不等于c++中的析构（c++中销毁对象必须用到析构函数）

3. 垃圾回收只与内存有关

   使用垃圾回收器的原因是为了回收程序不再使用的内存。无论对象时如何创建的，垃圾回收器都会负责释放对象占据的所有内存。

   因此**finalize()**的需求为：释放通过某种创建对象方式以外的方式为对象分配的存储空间。这种情况主要发生在使用“本地方法”的场景下，本地方法是在java中调用非java代码的方法，例如调用c的malloc函数分配存储空间，需要在**finalize()**中用本地方法调用c中的**free()**。

##### 5.5.4 垃圾回收器如何工作

java  语言中一个显著的特点就是引入了java回收机制，是c++程序员最头疼的内存管理的问题迎刃而解，它使java程序员在编写程序的时候不在考虑内存管理。java的所有对象都存储在堆上，垃圾回收器对于提高对象的创建速度，具有明显的效果。

内存泄漏：是指程序在申请内存后，无法释放已申请的内存空间，一次内存泄漏似乎不会有大的影响，但内存泄漏堆积后的后果就是内存溢出。

内存溢出：指程序申请内存时，没有足够的内存供申请者使用，或者说，给了你一块存储int类型数据的存储空间，但是你却存储long类型的数据，那么结果就是内存不够用，此时就会报错OOM,即所谓的内存溢出。 

**1）垃圾判断**

**引用计数法**

在这种算法中，假设堆中每个对象（不是引用）都有一个引用计数器。当一个对象被创建并且初始化赋值后，该对象的计数器的值就设置为 1，每当有一个地方引用它时，计数器的值就加 1，例如将对象 b 赋值给对象 a，那么 b 被引用，则将 b 引用对象的计数器累加 1。

反之，当引用失效时，例如一个对象的某个引用超过了生命周期（出作用域后）或者被设置为一个新值时，则之前被引用的对象的计数器的值就减 1。而那些引用计数为 0 的对象，就可以称之为垃圾，可以被收集。

特别地，当一个对象被当做垃圾收集时，它引用的任何对象的计数器的值都减 1。

优点：引用计数法实现起来比较简单，对程序不被长时间打断的实时环境比较有利。
缺点：需要额外的空间来存储计数器，难以检测出对象之间的循环引用。



**可达性分析法**
可达性分析法也被称之为根搜索法，可达性是指，如果一个对象会被至少一个在程序中的变量通过直接或间接的方式被其他可达的对象引用，则称该对象就是可达的。更准确的说，一个对象只有满足下述两个条件之一，就会被判断为可达的：

- 对象是属于根集中的对象

- 对象被一个可达的对象引用

在这里，我们引出了一个专有名词，即根集，其是指正在执行的 Java 程序可以访问的引用变量（注意，不是对象）的集合，程序可以使用引用变量访问对象的属性和调用对象的方法。在 JVM 中，会将以下对象标记为根集中的对象，具体包括：

- 虚拟机栈（栈帧中的本地变量表）中引用的对象
- 方法区中的常量引用的对象
- 方法区中的类静态属性引用的对象
- 本地方法栈中 JNI（Native 方法）的引用对象
- 活跃线程（已启动且未停止的 Java 线程）

根集中的对象称之为GC Roots，也就是根对象。可达性分析法的基本思路是：将一系列的根对象作为起始点，从这些节点开始向下搜索，搜索所走过的路径称为引用链，如果一个对象到根对象没有任何引用链相连，那么这个对象就不是可达的，也称之为不可达对象。不可达对象会被回收。


